# ================================
# CONTADOR DE ESCANEOS POR HORA
# Consola oculta / Form visible
# ================================

Add-Type @"
using System;
using System.Runtime.InteropServices;
public class Win32 {
    [DllImport("kernel32.dll")]
    public static extern IntPtr GetConsoleWindow();
    [DllImport("user32.dll")]
    public static extern bool ShowWindow(IntPtr hWnd, int nCmdShow);
}
"@
$h = [Win32]::GetConsoleWindow()
if ($h -ne [IntPtr]::Zero) { [Win32]::ShowWindow($h, 0) }

Add-Type -ReferencedAssemblies @(
    "System.Windows.Forms",
    "System.Drawing"
) -TypeDefinition @"
using System;
using System.Collections.Generic;
using System.Runtime.InteropServices;
using System.Windows.Forms;
using System.Drawing;

public class EscanerForm : Form
{
    private Label lblEscaneos;
    private Label lblTiempo;
    private Panel panelHistorial;
    private Timer timer;

    private static int contador = 0;
    private static string bufferEscaneo = "";
    private static IntPtr hookID = IntPtr.Zero;
    private static LowLevelKeyboardProc proc = HookCallback;

    private List<int> historialHoras = new List<int>();
    private int ultimaHora = DateTime.Now.Hour;
    private const int MAX_HORAS = 8;

    public EscanerForm()
    {
        this.Text = "Contador de Escaneos";
        this.Size = new Size(380,260);
        this.StartPosition = FormStartPosition.CenterScreen;
        this.TopMost = true;
        this.FormBorderStyle = FormBorderStyle.FixedDialog;
        this.MaximizeBox = false;

        lblEscaneos = new Label();
        lblEscaneos.Text = "Escaneos: 0";
        lblEscaneos.Font = new Font("Arial", 20, FontStyle.Bold);
        lblEscaneos.TextAlign = ContentAlignment.MiddleCenter;
        lblEscaneos.Dock = DockStyle.Top;
        lblEscaneos.Height = 55;

        lblTiempo = new Label();
        lblTiempo.Font = new Font("Arial", 11);
        lblTiempo.TextAlign = ContentAlignment.MiddleCenter;
        lblTiempo.Dock = DockStyle.Top;
        lblTiempo.Height = 25;

        panelHistorial = new Panel();
        panelHistorial.Dock = DockStyle.Fill;
        panelHistorial.Paint += DibujarHistorial;

        this.Controls.Add(panelHistorial);
        this.Controls.Add(lblTiempo);
        this.Controls.Add(lblEscaneos);

        hookID = SetHook(proc);

        timer = new Timer();
        timer.Interval = 1000;
        timer.Tick += (s,e) => TickReloj();
        timer.Start();

        ActualizarTiempo();
    }

    private void TickReloj()
    {
        ActualizarTiempo();

        int horaActual = DateTime.Now.Hour;
        if (horaActual != ultimaHora)
        {
            historialHoras.Add(contador);
            if (historialHoras.Count > MAX_HORAS)
                historialHoras.RemoveAt(0);

            contador = 0;
            lblEscaneos.Text = "Escaneos: 0";
            panelHistorial.Invalidate();

            ultimaHora = horaActual;
        }
    }

    private void ActualizarTiempo()
    {
        DateTime ahora = DateTime.Now;
        DateTime siguienteHora = new DateTime(
            ahora.Year, ahora.Month, ahora.Day,
            ahora.Hour, 0, 0).AddHours(1);

        TimeSpan restante = siguienteHora - ahora;

        lblTiempo.Text = string.Format(
            "Proximo corte: {0:D2}:{1:D2}",
            restante.Minutes,
            restante.Seconds
        );
    }

    private void DibujarHistorial(object sender, PaintEventArgs e)
    {
        if (historialHoras.Count == 0) return;

        int ancho = panelHistorial.Width;
        int alto = panelHistorial.Height;
        int barraAncho = ancho / MAX_HORAS;

        int maxValor = 1;
        foreach (int v in historialHoras)
            if (v > maxValor) maxValor = v;

        for (int i = 0; i < historialHoras.Count; i++)
        {
            int valor = historialHoras[i];
            int barraAlto = (int)((valor / (float)maxValor) * (alto - 20));

            Rectangle rect = new Rectangle(
                i * barraAncho + 5,
                alto - barraAlto - 5,
                barraAncho - 10,
                barraAlto
            );

            e.Graphics.FillRectangle(Brushes.SteelBlue, rect);
            e.Graphics.DrawRectangle(Pens.Black, rect);

            e.Graphics.DrawString(
                valor.ToString(),
                this.Font,
                Brushes.Black,
                rect.X,
                rect.Y - 15
            );
        }
    }

    protected override void OnFormClosed(FormClosedEventArgs e)
    {
        UnhookWindowsHookEx(hookID);
        base.OnFormClosed(e);
    }

    private static IntPtr SetHook(LowLevelKeyboardProc proc)
    {
        return SetWindowsHookEx(13, proc, IntPtr.Zero, 0);
    }

    private delegate IntPtr LowLevelKeyboardProc(int nCode, IntPtr wParam, IntPtr lParam);

    private static IntPtr HookCallback(int nCode, IntPtr wParam, IntPtr lParam)
    {
        if (nCode >= 0 && wParam == (IntPtr)0x0100)
        {
            int vkCode = Marshal.ReadInt32(lParam);

            if (vkCode >= 48 && vkCode <= 57)
                bufferEscaneo += (char)vkCode;
            else if (vkCode >= 96 && vkCode <= 105)
                bufferEscaneo += (char)(vkCode - 48);
            else if (vkCode == 13 || vkCode == 9)
            {
                if (bufferEscaneo.Length >= 8 && bufferEscaneo.Length <= 15)
                {
                    contador++;
                    EscanerForm f = (EscanerForm)Application.OpenForms[0];
                    f.BeginInvoke((Action)(() =>
                    {
                        f.lblEscaneos.Text = "Escaneos: " + contador;
                    }));
                }
                bufferEscaneo = "";
            }
            else bufferEscaneo = "";
        }
        return CallNextHookEx(hookID, nCode, wParam, lParam);
    }

    [STAThread]
    public static void Main()
    {
        Application.EnableVisualStyles();
        Application.Run(new EscanerForm());
    }

    [DllImport("user32.dll")]
    private static extern IntPtr SetWindowsHookEx(int idHook, LowLevelKeyboardProc lpfn, IntPtr hMod, uint dwThreadId);

    [DllImport("user32.dll")]
    private static extern bool UnhookWindowsHookEx(IntPtr hhk);

    [DllImport("user32.dll")]
    private static extern IntPtr CallNextHookEx(IntPtr hhk, int nCode, IntPtr wParam, IntPtr lParam);
}
"@

# ARRANCAR
[EscanerForm]::Main()
